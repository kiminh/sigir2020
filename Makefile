# Variables, customize to your environment
YAHOO_DIR ?= /Users/rolfjagerman/Datasets/Yahoo/set1
ISTELLA_DIR ?= /Users/rolfjagerman/Datasets/istella-s
BUILD ?= build
TRAIN_ARGS ?=

# Default is to run the entire experimental pipeline
.PHONY: all baselines clicklogs yahoo_clicklogs istella_clicklogs experiments
all: plots tables
baselines: $(BUILD)/baselines/yahoo.pth $(BUILD)/baselines/istella.pth
yahoo_clicklogs: $(BUILD)/clicklogs/yahoo_1m_perfect.clog
yahoo_clicklogs: $(BUILD)/clicklogs/yahoo_1m_position_eta_0.0.clog
yahoo_clicklogs: $(BUILD)/clicklogs/yahoo_1m_position_eta_0.5.clog
yahoo_clicklogs: $(BUILD)/clicklogs/yahoo_1m_position_eta_0.75.clog
yahoo_clicklogs: $(BUILD)/clicklogs/yahoo_1m_position_eta_1.0.clog
yahoo_clicklogs: $(BUILD)/clicklogs/yahoo_1m_position_eta_1.25.clog
yahoo_clicklogs: $(BUILD)/clicklogs/yahoo_1m_position_eta_1.5.clog
yahoo_clicklogs: $(BUILD)/clicklogs/yahoo_1m_position_eta_2.0.clog
yahoo_clicklogs: $(BUILD)/clicklogs/yahoo_1m_nearrandom_eta_1.0.clog
istella_clicklogs: $(BUILD)/clicklogs/istella_1m_perfect.clog
istella_clicklogs: $(BUILD)/clicklogs/istella_1m_position_eta_0.0.clog
istella_clicklogs: $(BUILD)/clicklogs/istella_1m_position_eta_0.5.clog
istella_clicklogs: $(BUILD)/clicklogs/istella_1m_position_eta_0.75.clog
istella_clicklogs: $(BUILD)/clicklogs/istella_1m_position_eta_1.0.clog
istella_clicklogs: $(BUILD)/clicklogs/istella_1m_position_eta_1.25.clog
istella_clicklogs: $(BUILD)/clicklogs/istella_1m_position_eta_1.5.clog
istella_clicklogs: $(BUILD)/clicklogs/istella_1m_position_eta_2.0.clog
istella_clicklogs: $(BUILD)/clicklogs/istella_1m_nearrandom_eta_1.0.clog
clicklogs: yahoo_clicklogs istella_clicklogs
experiments: yahoo_batch_sizes_repeat_5 istella_batch_sizes_repeat_5 yahoo_optimizers_repeat_5 istella_optimizers_repeat_5 yahoo_etas_repeat_5 istella_etas_repeat_5 $(BUILD)/skylines/yahoo.json $(BUILD)/skylines/istella.json


# Baseline rankers trained on fractions of data
$(BUILD)/baselines/yahoo.pth : | $(BUILD)/baselines/
	python -m experiments.baseline --train_data $(YAHOO_DIR)/train.txt \
		--vali_data $(YAHOO_DIR)/vali.txt \
		--output $@.tmp \
		--optimizer sgd \
		--lr 0.0001 \
		--fraction 0.001
	mv $@.tmp $@

$(BUILD)/baselines/yahoo.json : $(BUILD)/baselines/yahoo.pth | $(BUILD)/baselines/
	python -m experiments.eval_model --data $(YAHOO_DIR)/test.txt \
		--output $@.tmp \
		--model $(BUILD)/baselines/yahoo.pth
	mv $@.tmp $@

$(BUILD)/baselines/istella.pth : | $(BUILD)/baselines/
	python -m experiments.baseline --train_data $(ISTELLA_DIR)/train.txt \
		--vali_data $(ISTELLA_DIR)/vali.txt \
		--output $@.tmp \
		--optimizer sgd \
		--lr 0.001 \
		--fraction 0.001
	mv $@.tmp $@

$(BUILD)/baselines/istella.json : $(BUILD)/baselines/istella.pth | $(BUILD)/baselines/
	python -m experiments.eval_model --data $(ISTELLA_DIR)/test.txt \
		--output $@.tmp \
		--model $(BUILD)/baselines/istella.pth
	mv $@.tmp $@

$(BUILD)/baselines/ :
	mkdir -p $(BUILD)/baselines/


# Skyline rankers trained on full supervision data
$(BUILD)/skylines/yahoo.pth : | $(BUILD)/skylines/
	python -m experiments.baseline --train_data $(YAHOO_DIR)/train.txt \
		--vali_data $(YAHOO_DIR)/vali.txt \
		--output $@.tmp \
		--optimizer sgd \
		--lr 1e-03 \
		--fraction 1.0 \
		--epochs 10 \
		--batch_size 32
	mv $@.tmp $@

$(BUILD)/skylines/yahoo.json : $(BUILD)/skylines/yahoo.pth | $(BUILD)/skylines/
	python -m experiments.eval_model --data $(YAHOO_DIR)/test.txt \
		--output $@.tmp \
		--model $(BUILD)/skylines/yahoo.pth
	mv $@.tmp $@

$(BUILD)/skylines/istella.pth : | $(BUILD)/skylines/
	python -m experiments.baseline --train_data $(ISTELLA_DIR)/train.txt \
		--vali_data $(ISTELLA_DIR)/vali.txt \
		--output $@.tmp \
		--optimizer sgd \
		--lr 3e-04 \
		--fraction 1.0 \
		--epochs 10 \
		--batch_size 32
	mv $@.tmp $@

$(BUILD)/skylines/istella.json : $(BUILD)/skylines/istella.pth | $(BUILD)/skylines/
	python -m experiments.eval_model --data $(ISTELLA_DIR)/test.txt \
		--output $@.tmp \
		--model $(BUILD)/skylines/istella.pth
	mv $@.tmp $@

$(BUILD)/skylines/ :
	mkdir -p $(BUILD)/skylines/

# Click logs generated by baseline rankers
$(BUILD)/clicklogs/yahoo_1m_perfect.clog : $(BUILD)/baselines/yahoo.pth | $(BUILD)/clicklogs/
	python -m experiments.simulate_clicks --input_data $(YAHOO_DIR)/train.txt \
		--ranker $(BUILD)/baselines/yahoo.pth \
		--output_log $@ \
		--sessions 10_000_000 \
		--max_clicks 1_000_000 \
		--behavior perfect

$(BUILD)/clicklogs/yahoo_1m_position_eta_0.0.clog : $(BUILD)/baselines/yahoo.pth | $(BUILD)/clicklogs/
	python -m experiments.simulate_clicks --input_data $(YAHOO_DIR)/train.txt \
		--ranker $(BUILD)/baselines/yahoo.pth \
		--output_log $@ \
		--sessions 10_000_000 \
		--max_clicks 1_000_000 \
		--behavior position \
		--eta 0.0

$(BUILD)/clicklogs/yahoo_1m_position_eta_0.5.clog : $(BUILD)/baselines/yahoo.pth | $(BUILD)/clicklogs/
	python -m experiments.simulate_clicks --input_data $(YAHOO_DIR)/train.txt \
		--ranker $(BUILD)/baselines/yahoo.pth \
		--output_log $@ \
		--sessions 10_000_000 \
		--max_clicks 1_000_000 \
		--behavior position \
		--eta 0.5

$(BUILD)/clicklogs/yahoo_1m_position_eta_0.75.clog : $(BUILD)/baselines/yahoo.pth | $(BUILD)/clicklogs/
	python -m experiments.simulate_clicks --input_data $(YAHOO_DIR)/train.txt \
		--ranker $(BUILD)/baselines/yahoo.pth \
		--output_log $@ \
		--sessions 10_000_000 \
		--max_clicks 1_000_000 \
		--behavior position \
		--eta 0.75

$(BUILD)/clicklogs/yahoo_1m_position_eta_1.0.clog : $(BUILD)/baselines/yahoo.pth | $(BUILD)/clicklogs/
	python -m experiments.simulate_clicks --input_data $(YAHOO_DIR)/train.txt \
		--ranker $(BUILD)/baselines/yahoo.pth \
		--output_log $@ \
		--sessions 10_000_000 \
		--max_clicks 1_000_000 \
		--behavior position \
		--eta 1.0

$(BUILD)/clicklogs/yahoo_1m_position_eta_1.25.clog : $(BUILD)/baselines/yahoo.pth | $(BUILD)/clicklogs/
	python -m experiments.simulate_clicks --input_data $(YAHOO_DIR)/train.txt \
		--ranker $(BUILD)/baselines/yahoo.pth \
		--output_log $@ \
		--sessions 10_000_000 \
		--max_clicks 1_000_000 \
		--behavior position \
		--eta 1.25

$(BUILD)/clicklogs/yahoo_1m_position_eta_1.5.clog : $(BUILD)/baselines/yahoo.pth | $(BUILD)/clicklogs/
	python -m experiments.simulate_clicks --input_data $(YAHOO_DIR)/train.txt \
		--ranker $(BUILD)/baselines/yahoo.pth \
		--output_log $@ \
		--sessions 10_000_000 \
		--max_clicks 1_000_000 \
		--behavior position \
		--eta 1.5

$(BUILD)/clicklogs/yahoo_1m_position_eta_2.0.clog : $(BUILD)/baselines/yahoo.pth | $(BUILD)/clicklogs/
	python -m experiments.simulate_clicks --input_data $(YAHOO_DIR)/train.txt \
		--ranker $(BUILD)/baselines/yahoo.pth \
		--output_log $@ \
		--sessions 10_000_000 \
		--max_clicks 1_000_000 \
		--behavior position \
		--eta 2.0

$(BUILD)/clicklogs/yahoo_1m_nearrandom_eta_1.0.clog : $(BUILD)/baselines/yahoo.pth | $(BUILD)/clicklogs/
	python -m experiments.simulate_clicks --input_data $(YAHOO_DIR)/train.txt \
		--ranker $(BUILD)/baselines/yahoo.pth \
		--output_log $@ \
		--sessions 10_000_000 \
		--max_clicks 1_000_000 \
		--behavior nearrandom \
		--eta 1.0



$(BUILD)/clicklogs/istella_1m_perfect.clog : $(BUILD)/baselines/istella.pth | $(BUILD)/clicklogs/
	python -m experiments.simulate_clicks --input_data $(ISTELLA_DIR)/train.txt \
		--ranker $(BUILD)/baselines/istella.pth \
		--output_log $@ \
		--sessions 10_000_000 \
		--max_clicks 1_000_000 \
		--behavior perfect

$(BUILD)/clicklogs/istella_1m_position_eta_0.0.clog : $(BUILD)/baselines/istella.pth | $(BUILD)/clicklogs/
	python -m experiments.simulate_clicks --input_data $(ISTELLA_DIR)/train.txt \
		--ranker $(BUILD)/baselines/istella.pth \
		--output_log $@ \
		--sessions 10_000_000 \
		--max_clicks 1_000_000 \
		--behavior position \
		--eta 0.0

$(BUILD)/clicklogs/istella_1m_position_eta_0.5.clog : $(BUILD)/baselines/istella.pth | $(BUILD)/clicklogs/
	python -m experiments.simulate_clicks --input_data $(ISTELLA_DIR)/train.txt \
		--ranker $(BUILD)/baselines/istella.pth \
		--output_log $@ \
		--sessions 10_000_000 \
		--max_clicks 1_000_000 \
		--behavior position \
		--eta 0.5

$(BUILD)/clicklogs/istella_1m_position_eta_0.75.clog : $(BUILD)/baselines/istella.pth | $(BUILD)/clicklogs/
	python -m experiments.simulate_clicks --input_data $(ISTELLA_DIR)/train.txt \
		--ranker $(BUILD)/baselines/istella.pth \
		--output_log $@ \
		--sessions 10_000_000 \
		--max_clicks 1_000_000 \
		--behavior position \
		--eta 0.75

$(BUILD)/clicklogs/istella_1m_position_eta_1.0.clog : $(BUILD)/baselines/istella.pth | $(BUILD)/clicklogs/
	python -m experiments.simulate_clicks --input_data $(ISTELLA_DIR)/train.txt \
		--ranker $(BUILD)/baselines/istella.pth \
		--output_log $@ \
		--sessions 10_000_000 \
		--max_clicks 1_000_000 \
		--behavior position \
		--eta 1.0

$(BUILD)/clicklogs/istella_1m_position_eta_1.25.clog : $(BUILD)/baselines/istella.pth | $(BUILD)/clicklogs/
	python -m experiments.simulate_clicks --input_data $(ISTELLA_DIR)/train.txt \
		--ranker $(BUILD)/baselines/istella.pth \
		--output_log $@ \
		--sessions 10_000_000 \
		--max_clicks 1_000_000 \
		--behavior position \
		--eta 1.25

$(BUILD)/clicklogs/istella_1m_position_eta_1.5.clog : $(BUILD)/baselines/istella.pth | $(BUILD)/clicklogs/
	python -m experiments.simulate_clicks --input_data $(ISTELLA_DIR)/train.txt \
		--ranker $(BUILD)/baselines/istella.pth \
		--output_log $@ \
		--sessions 10_000_000 \
		--max_clicks 1_000_000 \
		--behavior position \
		--eta 1.5

$(BUILD)/clicklogs/istella_1m_position_eta_2.0.clog : $(BUILD)/baselines/istella.pth | $(BUILD)/clicklogs/
	python -m experiments.simulate_clicks --input_data $(ISTELLA_DIR)/train.txt \
		--ranker $(BUILD)/baselines/istella.pth \
		--output_log $@ \
		--sessions 10_000_000 \
		--max_clicks 1_000_000 \
		--behavior position \
		--eta 2.0

$(BUILD)/clicklogs/istella_1m_nearrandom_eta_1.0.clog : $(BUILD)/baselines/istella.pth | $(BUILD)/clicklogs/
	python -m experiments.simulate_clicks --input_data $(ISTELLA_DIR)/train.txt \
		--ranker $(BUILD)/baselines/istella.pth \
		--output_log $@ \
		--sessions 10_000_000 \
		--max_clicks 1_000_000 \
		--behavior nearrandom \
		--eta 1.0

$(BUILD)/clicklogs/ :
	mkdir -p $(BUILD)/clicklogs/


# Results
include makescripts/yahoo_optimizers.mk
include makescripts/yahoo_batch_sizes.mk
include makescripts/yahoo_etas.mk
include makescripts/istella_optimizers.mk
include makescripts/istella_batch_sizes.mk
include makescripts/istella_etas.mk
include makescripts/plots.mk
include makescripts/tables.mk

$(BUILD)/results/optimizers/ :
	mkdir -p $(BUILD)/results/optimizers/

$(BUILD)/results/batch_sizes/ :
	mkdir -p $(BUILD)/results/batch_sizes/

$(BUILD)/results/etas/ :
	mkdir -p $(BUILD)/results/etas/

$(BUILD)/plots/ :
	mkdir -p $(BUILD)/plots/
